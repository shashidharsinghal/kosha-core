# Notifications & Reminders – Technical Specification

## Technical Overview

The notifications service delivers timely reminders and updates about bills, payments, spending and goals.  It provides configurable delivery channels (email, push, SMS) and respects user preferences and Do‑Not‑Disturb settings.  Notifications are generated by other modules (bill management, payments) or scheduled by recurring jobs.  A simple document schema suffices, so MongoDB is used for storing notification messages and preferences.

### Data Model & Database Choice

Notifications are lightweight objects containing messages, status and metadata.  MongoDB’s flexible document store is ideal for such unstructured data【163388115766043†L175-L179】.  Collections:

* **notifications**: `_id` (ObjectId), `user_id`, `type` (`BILL_REMINDER`, `PAYMENT_SUCCESS`, `SUMMARY`, etc.), `message`, `channel` (`EMAIL`, `PUSH`, `SMS`), `status` (`PENDING`, `SENT`, `FAILED`), `scheduled_for`, `sent_at`, `metadata` (e.g., bill ID), `created_at`.  
* **notification_preferences**: `_id`, `user_id`, `channels` (list of enabled channels), `dnd_start`, `dnd_end`, `time_zone`, `weekly_summary_day`, `created_at`, `updated_at`.

Indexes on `user_id` and `scheduled_for` enable retrieval of pending notifications.

### REST API Endpoints

* `GET /api/v1/notifications` – Fetch notifications for the user; supports filters (status, date range).  
* `POST /api/v1/notifications/preferences` – Create or update user notification preferences (channels, DND).  
* `GET /api/v1/notifications/preferences` – Retrieve current preferences.  
* `POST /api/v1/notifications/test` – Send a test notification to verify channels.  

Routes adhere to proper HTTP verb usage and naming conventions【8357684761619†L134-L149】 and return appropriate status codes【8357684761619†L152-L162】.

### Notification Flow

1. **Generation:** Other modules (bill management, payments) emit events (e.g., upcoming due date, payment success).  A producer writes a `notifications` document with `status = PENDING` and `scheduled_for`.  
2. **Scheduler/Worker:** A job runner periodically scans for pending notifications with `scheduled_for <= now` and not in user’s DND period; it sends messages via the chosen channel (email via Gmail API, push via Firebase Cloud Messaging, SMS via Twilio).  
3. **Delivery Tracking:** After sending, update `status` to `SENT` and record `sent_at`.  Failures set `status = FAILED` and trigger retries or alternative channels.
4. **Summaries:** A weekly job compiles user summaries (spending, upcoming bills) and generates summary notifications according to user preferences.

### Implementation Tasks

1. **Define MongoDB schemas** for `notifications` and `notification_preferences` and create indexes.  
2. **Implement controllers** for retrieving notifications and managing preferences.  
3. **Develop services** for creating notifications from business events; respect preferences and DND windows.  
4. **Build notification workers** that poll pending notifications, send messages via providers (Gmail, push, SMS) and handle failures.  
5. **Integrate Gmail API** for email delivery; ensure messages use a consistent template.  
6. **Implement DND logic** to delay notifications until allowed times.  
7. **Write tests** covering preference updates, DND enforcement, multi‑channel delivery and summary generation, using realistic test conditions【551007709182127†L435-L475】.

## Acceptance Tests

* **Set Preferences:** Creating/updating preferences saves channels and DND; invalid channels return `400 Bad Request`.  
* **Generate Notification:** When a bill is due in three days, a `BILL_REMINDER` notification document is created with `status = PENDING` and `scheduled_for` set.  
* **Send Notification:** At the scheduled time and outside DND, the worker sends the message, updates status to `SENT` and records `sent_at`.  If sending fails, status becomes `FAILED` and the system retries or uses an alternative channel.  
* **DND Enforcement:** Notifications scheduled during DND are postponed until the end of the DND window.  
* **Weekly Summary:** The summary job creates and sends a summary notification on the user’s configured day; invalid preferences are skipped.

These tests ensure the notifications module functions as intended, satisfying its requirements while following best practices for iterative testing and documentation【551007709182127†L435-L475】.